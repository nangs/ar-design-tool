<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">Back</a>
    </div>
    <ul class="nav navbar-nav navbar-right ">
      <li>
        <a target="_self" href="/buildproject.php">
          <button type="button" class="btn btn-success btn-sm">Build APK</button>
        </a>
      <li>
        <a href="" ng-click="unityMapperService.saveState()">
          <button type="button" class="btn btn-success btn-sm" data-toggle="modal" data-target="#save">Save</button>
        </a>
      </li>
    </ul>
  </div>
</nav>

<!-- Modal for model options button -->
<bs-modal modal-id="myModal">
  <modal-body>
    <p><center>Choose your clickable object.</p></center>
    <div class="radio">
      <!-- check on how to use label in html -->
      <label><input type="radio" name="optradio">Object 1</label>
    </div>
    <div class="radio">
      <label><input type="radio" name="optradio">Object 2</label>
    </div>
    <div class="radio disabled">
      <label><input type="radio" name="optradio">Object 3</label>
    </div>
  </modal-body>
  <modal-footer>
    <button type="button" class="btn btn-default" data-dismiss="modal" style="display: block; margin: 0 auto;">Okay</button>
  </modal-footer>
</bs-modal>

<bs-modal modal-id="save">
  <modal-body>
    <p style="text-align:center">Work has been saved.</p>
  </modal-body>
  <modal-footer>
    <button type="button" class="btn btn-default" data-dismiss="modal" style="display: block; margin: 0 auto;">Okay</button>
  </modal-footer>
</bs-modal>

<!-- Modal warning for delete state button -->
<bs-modal modal-id="deleteState">
  <modal-body>
    <p style="text-align:center">Are you sure you want to delete this state?</p>
  </modal-body>
  <modal-footer>
    <a href="#" id="btnYes" class="btn danger">Yes</a>
    <a href="#" data-dismiss="modal" aria-hidden="true" class="btn secondary">No</a>
  </modal-footer>
</bs-modal>

<!-- Modal warning for delete connection -->
<bs-modal modal-id="deleteConn">
  <modal-body>
    <p style="text-align:center">Are you sure you want to delete this connection?</p>
  </modal-body>
  <modal-footer>
    <a href="#" id="btnYesConn" class="btn danger">Yes</a>
    <a href="#" data-dismiss="modal" aria-hidden="true" class="btn secondary">No</a>
  </modal-footer>
</bs-modal>

<div class="row">
  <div class="scrollbar" id="style-default">
    <div id="items">
      <h1>Step One:</h1>
      <button type = "button" class="button_add_task btn btn-primary btn-md">Click here to create a new state!</button><p></p>
      <h1>Step Two:</h1>
      <p>Give your state a name.</p>
      <h1>Step Three:</h1>
      <p>Edit your state by clicking <span class="glyphicon glyphicon-new-window"></span></p>
      <h1>Step Four:</h1>
      <p>Drag and drop lines from the blue circle to connect your states.</p>
      <h1>Step Five:</h1>
      <p>Choose your clickable object by clicking <span class='glyphicon glyphicon-resize-horizontal'></span></p>
      <br>
      <p>Made a mistake? Double click on your connection line to delete it. 
        Click <span class="glyphicon glyphicon-remove-circle"></span> to delete your entire state.
      </p>
  </div>
  <div class="force-overflow"></div>
  </div>
    
  <div class="col-sm-8">
    <div id="drawingArea" style="width:100%;min-height:500px;">
      <div class="startpoint point window node" style="left: 150px; top:20px" data-nodetype="startpoint" id="startpoint">
        <div class="editor_container">
          <div class="button_editor">
            <a ng-click="editorService.openEditor()" href="">
              <span class="glyphicon glyphicon-new-window"></span>
            </a>
          </div>
        </div>
        Root State
      </div>    
      <div class="window task" style="left: 120px; top:200px; display:none;" data-nodetype="task" id="taskcontainer0">
        <div class="ctrl_container">
          <div class="button_remove"><span class="glyphicon glyphicon-remove-circle"></span></div>
          <div class="button_editor">
            <a ng-click="editorService.openEditor()" href="">
              <span class="glyphicon glyphicon-new-window"></span>
            </a>
          </div>
        </div>
        <div class="details_container">
            <!--<label class="detail_label">Name</label>-->
            <input value="" placeholder="State Name" class="detail_text"/>
        </div>
      </div>
      <!--For debugging purposes-->
      <textarea id="jsonOutput" style="width:10px;height:10px;"></textarea>
    </div>
  </div>
</div>


<script type="text/javascript">  
  var SendMessage = function(a,b,c) {
    return 0;
  }
  var CreateState = function(id, name) {
    console.log("called");
  }
  
  var angularHelper = (function () {
    var angularHelper = function () { };
    var defaultApplicationName = "vumixEditorApp";
    angularHelper.compile = function ($targetDom, htmlToCompile, applicationName) {
      var $injector = angular.injector(["ng", applicationName || defaultApplicationName]);
      $injector.invoke(["$compile", "$rootScope", function ($compile, $rootScope) {
        var $scope = $targetDom.append(htmlToCompile).scope();
        $compile($targetDom)($scope || $rootScope);
        $rootScope.$digest();
      }]);
    }
    return angularHelper;
  })();
  
	var numberOfElements = 0;
var htmlBase = 'drawingArea';
jsPlumb.ready(function () {
        
	//FIX DOM:
	$(("#taskcontainer0"))[0].innerHTML = $(("#taskcontainer0"))[0].innerHTML;

	jsPlumb.draggable($(".window"));
	
	jsPlumb.importDefaults({
		Endpoint : ["Dot", {radius:8}],
		EndpointStyle : { fillStyle : "#4A6" },
		HoverPaintStyle : {strokeStyle:"#42a62c", lineWidth:8 },
		Connector:[ "Flowchart" ],
		ConnectionOverlays : [
			[ "Arrow", { 
				location:1,
				id:"arrow",
				length:20,
				foldback:0.4
			} ],
            [ "Label", { 
						location:[ 2, 2],
                        label:"<button type='button' class='btn btn-default btn-xs' data-toggle='modal' data-target='#myModal'><span class='glyphicon glyphicon-resize-horizontal'></span></button>",
						cssClass:"aLabel",
					}]
		]
	});

	var workflowConnectorStartpoint = {
		isSource: true,
		isTarget: false,
		maxConnections: 10,					 
		anchor:"BottomCenter"
	};
	
	var workflowConnectorEndpoint = {
		isSource: false,
		isTarget: true,
		maxConnections: -1,				 
		anchor:"TopCenter",
		paintStyle: { fillStyle: 'red' },
		endpoint: ["Rectangle", {width:12, height:12}]
	};
	
	jsPlumb.addEndpoint(
		$('.startpoint'),
		workflowConnectorStartpoint
	);
	
	jsPlumb.addEndpoint(
		$('.endpoint'),
		workflowConnectorEndpoint
	);
					
    jsPlumb.bind('dblclick', function (connection, e) {
            jsPlumb.detach(connection);
    });
		
	$('#'+htmlBase).on("click", ".button_remove", function () {
		var parentnode = $(this)[0].parentNode.parentNode;
		jsPlumb.detachAllConnections(parentnode);
		jsPlumb.removeAllEndpoints(parentnode);
		$(parentnode).remove(); 
	});
	
	$(".button_add_task").click(function () {
		addTask();
	});
					
	$('.button_save_task').click(function(){
		saveFlowchart();
	});
	
	$('.button_load_task').click(function(){
		loadFlowchart();
	});
});
function addTask(id){
	if(typeof id === "undefined"){
		numberOfElements++;
		id = "taskcontainer" + numberOfElements;
	}
	
	$('<div class="window task node" id="' + id + '" data-nodetype="task" style="left:30px; top:30px;">').appendTo('#'+htmlBase).html($(("#taskcontainer0"))[0].innerHTML);
						
	var taskSourceConnectorEndpoint = {
		isSource: true,
		isTarget: false,
		maxConnections: 10,
        anchor: "Continuous",
	};
	
	jsPlumb.addEndpoint(
		$('#'+id),
		taskSourceConnectorEndpoint
	);
	
	jsPlumb.makeTarget(
        $('#'+id), {
		  anchor: 'Continuous'
		});
    
	jsPlumb.draggable($('#' + id));
	return id;
}

function saveFlowchart(){
	var nodes = []
	$(".node").each(function (idx, elem) {
	var $elem = $(elem);
	var endpoints = jsPlumb.getEndpoints($elem.attr('id'));
	console.log('endpoints of '+$elem.attr('id'));
	console.log(endpoints);
		nodes.push({
			blockId: $elem.attr('id'),
			nodetype: $elem.attr('data-nodetype'),
			positionX: parseInt($elem.css("left"), 10),
			positionY: parseInt($elem.css("top"), 10)
		});
	});
	var connections = [];
	$.each(jsPlumb.getConnections(), function (idx, connection) {
		connections.push({
			connectionId: connection.id,
			pageSourceId: connection.sourceId,
			pageTargetId: connection.targetId
		});
	});
	
	var flowChart = {};
	flowChart.nodes = nodes;
	flowChart.connections = connections;
	flowChart.numberOfElements = numberOfElements;
	
	var flowChartJson = JSON.stringify(flowChart);
	//console.log(flowChartJson);
	
	$('#jsonOutput').val(flowChartJson);
}
function loadFlowchart(){
	var flowChartJson = $('#jsonOutput').val();
	var flowChart = JSON.parse(flowChartJson);
	var nodes = flowChart.nodes;
	$.each(nodes, function( index, elem ) {
		if(elem.nodetype === 'startpoint'){
			repositionElement('startpoint', elem.positionX, elem.positionY);
		}else if(elem.nodetype === 'endpoint'){
			repositionElement('endpoint', elem.positionX, elem.positionY);
		}else if(elem.nodetype === 'task'){
			var id = addTask(elem.blockId);
			repositionElement(id, elem.positionX, elem.positionY);
		}else if(elem.nodetype === 'decision'){
			var id = addDecision(elem.blockId);
			repositionElement(id, elem.positionX, elem.positionY);
		}else{
			
		}
	});
							
	var connections = flowChart.connections;
	$.each(connections, function( index, elem ) {
		 var connection1 = jsPlumb.connect({
			source: elem.pageSourceId,
			target: elem.pageTargetId,
			anchors: ["BottomCenter", [0.75, 0, 0, -1]]
			
		});
	});
	
	numberOfElements = flowChart.numberOfElements;
}
function repositionElement(id, posX, posY){
	$('#'+id).css('left', posX);
	$('#'+id).css('top', posY);
	jsPlumb.repaint(id);
}
</script>